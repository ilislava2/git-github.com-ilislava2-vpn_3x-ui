 # Пошаговая настройка сервера
 ### 1. Меняем пароль пользователя и Root
 ***На этом этапе все действия выполняются в терминале виртуальной машины.***
 
 *** Далее установки и настройки проходят по пользователем Root***
 
 Чтобы перейти с **user** в  **root** команда в терминале: **-i**
 
 для пользователя без кавычек:
 ```
passw "user login"
```
для Root:
```
 passw
 ```

 ### 2. Обновляем систему 
```
apt update  && apt udgrade
```
### 3. Перезагрузка сервера

```
reboot
```
 
### 4. Устанавливаем панель 3x-ui (https://github.com/MHSanaei/3x-ui)
```
bash <(curl -Ls https://raw.githubusercontent.com/mhsanaei/3x-ui/master/install.sh)
```
***Даные вводимые ниже желательно записать-запомнить*** 
* На вопрос о новой конфинурации или дефолной: **Yes**
* Вводим номер порта для WEB страницы:
* Вводим логин пользователя для WEB интерфейса:
* Вводим пароль для нового пользователя:
* Подтверждаем пароль:
* Вводим окончание WEB страницы (хаотичный ввод символов):
  
 ### 5. Запускаем скрипт, который установит SSL-сертификат в панель для безопасного входа
 
``` 
bash <(curl -Ls https://raw.githubusercontent.com/cyb3rm4gus/3x-ui-auto_add_ssl/main/3x-ui-autossl.sh)
```
***После этой операции можно заходить через SSH в терминал***

### 6. Установка Cloudflare WARP
- Вводим команду терминале x-ui, в появившемся меню выбираем пункт **21**, затем опцию **1**. Порт устанавливаем **40000**
### 7. Установка fail2ban
- Вводим команду в терминале x-ui для вызова меню, выбираем пункт **20**, затем опцию **1**, дожидаемся завершения.
### 8. Перезагрузка панели для применения настроек
- Вводим команду в терминале x-ui, в появившемся меню выбираем пункт **13**
### 9. Перезагрузка сервера
```
reboot
```
### 10. WEB интерфейс сервера
Заходим на сервер по адресу: https://ip_сервера:порт/web-base-path, порт и web-base-path вы указывали выше при установки 3X-ui , и вы их сохранили. Если нет, вызовите меню командой x-ui и выберите пункт 10 для просмотра конфигурации.

### 11. Изменение настроек геопозиции 
После ввода логина и пароля перейдите в раздел настройки xray, выберите WARP. Изменить настройки геопозиции.
```
geosite:category-gov-ru,regexp:.*\.ru$,regexp:.*\.su$
```
После этого обязательно нажмите вверху **"сохранить"** и **"перезагрузить"**. Через меню x-ui
### 12. Создание первого клиента
- В настройках безопасности выбираем **REALITY** и жмем **Get New Cert** ниже.
- Раскрываем поле **"клиент"** и в **Flow** выбираем **xtls-rprx-vision**	
- Изменяем **yahoo.com** и **www.yahoo.com** на **google.com** и **www.google.com**
- В пункте **uTLS** выбираем **chrome**
- После этого жмем **создат**ь.
- Конфиг и сервер готовы к использованию.
### 13. Создание клиентов в рамках одно клиена и порта
- После создания первого криента раскрываем меню "три точки" первого клиента и добавляем несколько пользователей
- Указываем количество в поле  **Flow** выбираем **xtls-rprx-vision**
- Далее нажимаем кнопку добавить несколько
- На раскрытом **+** увидим созданых клиентов.
- В вкладке *карандаш* можно в поле Email  вписать-изменить данные пользователя.

   *** Проверяем что канал поднимается и продолжаем настраивать***
  
##  Поднимаем безопастность сервера
### 14. Устанавливаем Firewall Management (ufw)
- Проверяем открытые порты системы 
```
ufw status
```
- По полученным данным формируем строку из портов через запятую без пробела пример(22,443,40000)
- Устанавливаем через команду в терминале x-ui пункт **2"Firewall Management"** пункт **1**
	* Вставляем ранее подготовленныю строку с портами для открытия
- Для добавления после установки UDP  портов команда
```
ufw allow 14198/udp
```
или
```
ufw allow 14198/tcp
```
- Для проверки  проверки открытия команда:
```
ufw status
```
### 15.	Защитим сервер от взлома через брутфорс:
команда:
```
touch /etc/fail2ban/jail.local && nano /etc/fail2ban/jail.local
```
Копируем и вставляем:
```
[sshd]
enabled = true
filter = sshd
action = iptables[name=SSH, port=ssh, protocol=tcp]
logpath = /var/log/auth.log
findtime = 600
maxretry = 3
bantime = 43200
```
### 16.	Отключаем двухсторонний пинг
команда: 
```
nano /etc/ufw/before.rules
```
* в 4 строчке раздела меняем с **ACCEPT на DROP**\
ok icmp codes for INPUT\
-A ufw-before-input -p icmp --icmp-type destination-unreachable -j ACCEPT\
-A ufw-before-input -p icmp --icmp-type time-exceeded -j ACCEPT\
-A ufw-before-input -p icmp --icmp-type parameter-problem -j ACCEPT\
-A ufw-before-input -p icmp --icmp-type echo-request -j **DROP**
